<ng-container *ngIf="(ecoLearnState$ | async) as state" [ngSwitch]="state.dataState">
  <ng-container *ngSwitchCase="DataState.LOADED">
    <app-navbar [user]="state?.appData?.data?.user"></app-navbar>

    <div style="margin-top: 100px"> </div>
    <section>
      <div class="container mt-4">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a [routerLink]="['/']">Home</a></li>
            <li class="breadcrumb-item"><a [routerLink]="['/eco-learn']">EcoLearn</a></li>
            <li class="breadcrumb-item active" aria-current="page">New</li>
          </ol>
        </nav>

        <div class="eco-learn-container">
          <div class="d-flex">
            <div ngbNav #nav="ngbNav"  class="nav-pills flex-column" orientation="vertical">
              <ng-container ngbNavItem="all">
                <button ngbNavLink (click)="updateActiveTab('all')">All Resources</button>
                <ng-template ngbNavContent>
                  <ng-container *ngTemplateOutlet="postsFeed"></ng-container>
                </ng-template>
              </ng-container>
              <ng-container ngbNavItem="liked">
                <button ngbNavLink (click)="updateActiveTab('liked')">My Favourites</button>
                <ng-template ngbNavContent>
                  <ng-container *ngTemplateOutlet="postsFeed"></ng-container>
                </ng-template>
              </ng-container>
              <ng-container ngbNavItem="saved">
                <button ngbNavLink (click)="updateActiveTab('saved')">Saved For Later</button>
                <ng-template ngbNavContent>
                  <ng-container *ngTemplateOutlet="postsFeed"></ng-container>
                </ng-template>
              </ng-container>
            </div>

            <div [ngbNavOutlet]="nav" class="flex-grow-1 ms-4"></div>
          </div>

          <!-- New Resource Form -->

          <ng-template #postsFeed>
            <div class="posts-container">
              <ng-container *ngFor="let resource of state?.appData?.data?.page?.content">
                <div class="post-card">
                  <div class="post-header">
                    <h3 class="post-title">{{resource.title}}</h3>
                    <p class="post-details">
                      {{resource.createdAt | date: 'longDate'}} •
                      {{resource.contentType}} •
                      <mat-chip-list class="custom-chip-list">
                        <mat-chip *ngFor="let category of resource.categories" class="custom-chip" selected>
                          {{category}}
                        </mat-chip>
                      </mat-chip-list>

                    </p>
                  </div>
                  <div class="post-body">
                    <p class="post-text" [class.collapsed]="shouldCollapse(resource.content)">{{resource.content}}</p>
                    <a *ngIf="shouldCollapse(resource.content)"  class="view-more">View More</a>
                    <ng-container  *ngIf="resource.contentType !== 'VIDEO'" >

                      <img [src]="resource.media" width="1080" height="480" class="img-responsive post-media" alt="">
                    </ng-container>

                    <ng-container *ngIf="resource.contentType === 'VIDEO'">

                      <vg-player [style.width]="'780px'" [style.height]="'480px'">
                        <vg-overlay-play></vg-overlay-play>
                        <vg-buffering></vg-buffering>
                        <vg-scrub-bar>
                          <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
                          <!--                    <vg-scrub-bar-buffering-time></vg-scrub-bar-buffering-time>-->
                        </vg-scrub-bar>
                        <vg-controls>
                          <vg-play-pause></vg-play-pause>
                          <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
                          <vg-scrub-bar style="pointer-events: none;"></vg-scrub-bar>
                          <vg-track-selector></vg-track-selector>
                          <vg-mute></vg-mute>
                          <vg-volume></vg-volume>
                          <vg-fullscreen></vg-fullscreen>
                        </vg-controls>
                        <vg-buffering></vg-buffering>
                        <video  [vgMedia]="$any(media)" #media id="resourceVideo" preload="auto" crossorigin>
                          <source [src]="resource.media" type="video/mp4">
                        </video>
                      </vg-player>
                    </ng-container>
                  </div>
                  <div class="post-footer">
                    <button class="icon-btn"><i class="fas fa-thumbs-up"></i></button>
                    <button class="icon-btn"><i class="fas fa-share-alt"></i></button>
                    <button class="icon-btn"><i class="fas fa-bookmark"></i></button>
                  </div>
                </div>
              </ng-container>
            </div>


          </ng-template>


          <aside class="filter-sidebar">
            <div class="mb-4">
              <h5 >Apply Filters</h5>
            </div>


            <form [formGroup]="searchForm" (submit)="searchEducationalResourcesSubmit($event)">
              <input formControlName="title" placeholder="Search by title" class="form-control">

              <input type="text" formControlName="contentType" class="form-control" id="contentType" [typeahead]="availableContentTypes" [minLength]="0" [typeaheadWaitMs]="10" placeholder="Select Post Content Type">


              <!-- Categories Filter -->
              <input type="text" formControlName="categories" class="form-control" id="categories" [typeahead]="availableCategories" [minLength]="0" [typeaheadWaitMs]="10" placeholder="Select Category" (typeaheadOnSelect)="onSelectCategory($event)">

              <!-- Sorting Options -->
              <select formControlName="sortBy" class="form-control">
                <option value="createdAt">Date Posted</option>
                <option value="title">Title</option>
              </select>

              <select formControlName="sortOrder" class="form-control">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
              </select>

              <input formControlName="likedOnly" class="invisible-form" type="checkbox">
              <input formControlName="savedOnly" class="invisible-form" type="checkbox">

              <button type="submit"
                      class="btn btn-outline-secondary"
                      (click)="resetFilters()"
                      [matTooltipShowDelay]="800"
                      [matTooltipHideDelay]="800"
                      matTooltip="Clear all applied filters">
                Clear Filters
              </button>
            </form>

            <div *ngIf="selectedCategories.length > 0" class="recommended-categories">
              <h5>Selected Categories</h5>
              <div class="categories-chips">

                <mat-chip-list class="custom-chip-list">
                  <mat-chip *ngFor="let category of selectedCategories" class="custom-chip" selected>
                    {{category}}
                    <button matChipRemove aria-label="Remove" (click)="onRemoveCategory(category)">
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip>
                </mat-chip-list>
              </div>
            </div>

            <!-- Recommended Categories -->
            <div class="recommended-categories">
              <h5>Recommended Categories</h5>
              <div class="categories-chips">

                <mat-chip-list class="custom-chip-list">
                  <mat-chip *ngFor="let category of availableCategories" class="custom-chip" selected (click)="addCategoryIfNotExists(category)">
                    {{category}}
                  </mat-chip>
                </mat-chip-list>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </ng-container>
</ng-container>
